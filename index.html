<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- CONFIGURAﾃﾃグ (Nﾃグ MEXA AQUI) ---
        const firebaseConfig = {
            apiKey: "AIzaSyAxWEuumY-TGqhHb1KxV6bDiQJ6ugxvJA8",
            authDomain: "curriculovivo.firebaseapp.com",
            projectId: "curriculovivo",
            storageBucket: "curriculovivo.firebasestorage.app",
            messagingSenderId: "245934457904",
            appId: "1:245934457904:web:0cdd30c1b145cfd4b119f5"
        };

        // --- COLOQUE SUA CHAVE AQUI ---
        // Se vocﾃｪ nﾃ｣o colocar a chave, a foto Nﾃグ vai aparecer.
        const IMGBB_API_KEY = "COLE_SUA_API_KEY_AQUI"; 

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // Elementos
        const btnLogin = document.getElementById('btn-login');
        const btnLogout = document.getElementById('btn-logout');
        const btnSave = document.getElementById('btn-save');
        const fileInput = document.getElementById('file-input');
        const fileNameDisplay = document.getElementById('file-name');

        // UI: Mostrar nome do arquivo
        fileInput.onchange = () => {
            if (fileInput.files.length > 0) {
                fileNameDisplay.innerText = fileInput.files[0].name;
                fileNameDisplay.style.color = "#4A90E2";
            }
        };

        // Login
        btnLogin.onclick = async () => {
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Erro Login:", error);
                alert("Erro no Login. Verifique o console (F12).");
            }
        };

        // Logout
        btnLogout.onclick = () => signOut(auth);

        // Monitorar Autenticaﾃｧﾃ｣o
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('user-display').classList.remove('hidden');
                document.getElementById('editor-section').classList.remove('hidden');
                btnLogin.classList.add('hidden');
                document.getElementById('user-photo').src = user.photoURL;
                carregarPosts(user.uid);
            } else {
                document.getElementById('user-display').classList.add('hidden');
                document.getElementById('editor-section').classList.add('hidden');
                btnLogin.classList.remove('hidden');
                document.getElementById('timeline').innerHTML = "<p style='text-align:center; padding:20px; color:#666;'>Faﾃｧa login para ver seu diﾃ｡rio.</p>";
            }
        });

        // --- FUNﾃﾃグ DE SALVAR (AQUI ESTAVA O PROBLEMA PROVﾃ〃EL) ---
        btnSave.onclick = async () => {
            const title = document.getElementById('skill-input').value;
            const desc = document.getElementById('exp-input').value;
            const imageFile = fileInput.files[0];

            if (!title || !desc) {
                return alert("Por favor, preencha o tﾃｭtulo e a descriﾃｧﾃ｣o!");
            }

            // Trava o botﾃ｣o para nﾃ｣o clicar duas vezes
            btnSave.disabled = true;
            btnSave.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';

            try {
                let finalImageUrl = null; // Comeﾃｧa nulo

                // 1. SE TIVER IMAGEM, FAZ O UPLOAD NO IMGBB
                if (imageFile) {
                    console.log("Iniciando upload para ImgBB...");
                    
                    const formData = new FormData();
                    formData.append("image", imageFile);

                    // Faz a requisiﾃｧﾃ｣o para o ImgBB
                    const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                        method: "POST",
                        body: formData
                    });

                    const result = await response.json();
                    console.log("Resposta do ImgBB:", result); // OLHE O CONSOLE SE FALHAR

                    if (result.success) {
                        finalImageUrl = result.data.url; // Pega o link direto
                        console.log("Link da imagem gerado:", finalImageUrl);
                    } else {
                        throw new Error("O ImgBB rejeitou o upload. Verifique a API KEY.");
                    }
                }

                // 2. SALVA NO FIRESTORE COM O LINK DA IMAGEM
                await addDoc(collection(db, "experiencias"), {
                    uid: auth.currentUser.uid,
                    titulo: title,
                    descricao: desc,
                    imagem: finalImageUrl, // Salva o link (ou null se nﾃ｣o tiver foto)
                    data: new Date()
                });

                console.log("Salvo no Firestore com sucesso!");

                // Limpa o formulﾃ｡rio
                document.getElementById('skill-input').value = "";
                document.getElementById('exp-input').value = "";
                fileInput.value = "";
                fileNameDisplay.innerText = "Nenhuma foto selecionada";

            } catch (error) {
                console.error("ERRO AO SALVAR:", error);
                alert("Erro: " + error.message);
            } finally {
                btnSave.disabled = false;
                btnSave.innerText = "Publicar no Diﾃ｡rio";
            }
        };

        // --- CARREGAR POSTS (CORRIGIDO) ---
        function carregarPosts(uid) {
            const q = query(collection(db, "experiencias"), where("uid", "==", uid), orderBy("data", "desc"));
            
            onSnapshot(q, (snapshot) => {
                const timeline = document.getElementById('timeline');
                timeline.innerHTML = ""; // Limpa a timeline antes de redesenhar

                if (snapshot.empty) {
                    timeline.innerHTML = "<p style='text-align:center; color:#999; margin-top:20px;'>Nenhuma memﾃｳria salva ainda. Comece agora! 噫</p>";
                    return;
                }

                snapshot.forEach((doc) => {
                    const post = doc.data();
                    
                    // Formata a data com seguranﾃｧa
                    let dateString = "Data desconhecida";
                    if (post.data && post.data.toDate) {
                        dateString = post.data.toDate().toLocaleDateString('pt-BR', { 
                            day: '2-digit', month: 'long', year: 'numeric', hour: '2-digit', minute:'2-digit' 
                        });
                    }

                    // Verifica se existe imagem e se ela nﾃ｣o ﾃｩ vazia
                    let imgHtml = "";
                    if (post.imagem && post.imagem.trim() !== "") {
                        imgHtml = `<img src="${post.imagem}" class="post-img" alt="Foto da atividade" onerror="this.style.display='none'">`;
                    }

                    // Cria o HTML do Card
                    const cardHtml = `
                        <div class="experience-item">
                            ${imgHtml}
                            <div class="post-content">
                                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                                    <span class="post-date"><i class="far fa-clock"></i> ${dateString}</span>
                                </div>
                                <h3 style="margin: 0 0 10px 0; color: #2d3748;">${post.titulo}</h3>
                                <p style="margin: 0; color: #4a5568; line-height: 1.6;">${post.descricao}</p>
                            </div>
                        </div>
                    `;
                    
                    timeline.innerHTML += cardHtml;
                });
            });
        }
    </script>
